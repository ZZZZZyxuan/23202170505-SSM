<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zhengyuxuan.dao.MovieMapper">

    <!-- 电影结果映射 -->
    <resultMap id="MovieResultMap" type="Movie">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="director" column="director"/>
        <result property="actors" column="actors"/>
        <result property="genre" column="genre"/>
        <result property="region" column="region"/>
        <result property="releaseDate" column="release_date"/>
        <result property="duration" column="duration"/>
        <result property="poster" column="poster"/>
        <result property="synopsis" column="synopsis"/>
        <result property="avgRating" column="avg_rating"/>
        <result property="ratingCount" column="rating_count"/>
    </resultMap>

    <!-- 根据ID查询电影 -->
    <select id="selectById" resultMap="MovieResultMap">
        SELECT id, title, director, actors, genre, region, release_date,
               duration, poster, synopsis, avg_rating, rating_count
        FROM t_movie
        WHERE id = #{id}
    </select>

    <!-- 查询所有电影 -->
    <select id="selectAll" resultMap="MovieResultMap">
        SELECT id, title, director, actors, genre, region, release_date,
               duration, poster, synopsis, avg_rating, rating_count
        FROM t_movie
        ORDER BY avg_rating DESC, rating_count DESC
    </select>

    <!-- 根据条件查询电影（动态SQL） -->
    <select id="selectByCondition" resultMap="MovieResultMap">
        SELECT id, title, director, actors, genre, region, release_date,
               duration, poster, synopsis, avg_rating, rating_count
        FROM t_movie
        <where>
            <if test="genre != null and genre != ''">
                AND genre = #{genre}
            </if>
            <if test="region != null and region != ''">
                AND region = #{region}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                     OR director LIKE CONCAT('%', #{keyword}, '%')
                     OR actors LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY avg_rating DESC, rating_count DESC
    </select>

    <!-- 查询所有电影类型 -->
    <select id="selectAllGenres" resultType="String">
        SELECT DISTINCT genre FROM t_movie WHERE genre IS NOT NULL ORDER BY genre
    </select>

    <!-- 查询所有电影地区 -->
    <select id="selectAllRegions" resultType="String">
        SELECT DISTINCT region FROM t_movie WHERE region IS NOT NULL ORDER BY region
    </select>

    <!-- 更新电影评分 -->
    <update id="updateRating">
        UPDATE t_movie
        SET avg_rating = #{avgRating}, rating_count = #{ratingCount}
        WHERE id = #{movieId}
    </update>

    <!-- 插入新电影 -->
    <insert id="insert" parameterType="Movie" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO t_movie (title, director, actors, genre, region, release_date,
                            duration, poster, synopsis, avg_rating, rating_count)
        VALUES (#{title}, #{director}, #{actors}, #{genre}, #{region}, #{releaseDate},
                #{duration}, #{poster}, #{synopsis}, #{avgRating}, #{ratingCount})
    </insert>

</mapper>

